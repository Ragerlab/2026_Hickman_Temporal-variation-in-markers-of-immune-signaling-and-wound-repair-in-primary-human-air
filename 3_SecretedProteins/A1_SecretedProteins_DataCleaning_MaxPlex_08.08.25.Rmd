---
title: "HBEC Acute vs Repeated Red Oak Exposure: Secreted Protein Analysis (MaxPlex Data Cleaning)"
author: "Elise Hickman"
---

# Set up workspace

```{r message = FALSE, warning = FALSE}
# Clear global environment
rm(list=ls())

# Load packages
library(this.path) # for file path
library(janitor) # for data cleaning
library(openxlsx) # for writing out files
library(tidyverse) # for data organization and manipulation
library(patchwork) # for graphing
library(biomaRt) # for Uniprot to description conversion
library(ggpubr) # for normality testing QQ plot panel
library(rstatix) # for statistical testing

# Redefine functions that may be masked
select <- dplyr::select
rename <- dplyr::rename
margin <- ggplot2::margin
slice <- dplyr::slice

# Set theme
theme_set(theme_bw())

# Set working directory
setwd(this.dir())
```

# MaxPlex 

## Import and clean data

```{r} 
# Read in unmodified data frame
prot_data_raw <- read.xlsx("1_RawData/RawData_SecretedProteins_MaxPlex.xlsx")

# Proteins on the original MaxPlex lsit
full_list <- read.xlsx("2_SampleInfo/nELISA_Targets_Maxplex.xlsx") %>%
  row_to_names(1)

# Create key for protein info
prot_key <- prot_data_raw %>% 
  
  # Get only part of file that will assist with assigning protein names and LODs
  slice(1:4) %>%
  select(17:279) %>%
  
  # Clean column names and formatting
  column_to_rownames("nELISA.ID:") %>%
  t() %>% data.frame() %>%
  rename("Uniprot_ID" = "Uniprot.ID.", "Protein_Name" = "Protein.Name.", 
         "Upper_LOD" = "Upper.Limit.of.Detection..pg.ml.", "Lower_LOD" = "Lower.Limit.of.Detection..pg.ml.") %>%
  rownames_to_column("nELISA_ID") %>%
  
  # Create new column for more R compatible column names
  ## Remove parenthethicals from protein names
  mutate(Prot_Col_Name = sub("\\(.*", "", Protein_Name)) %>%
  ## Replace spaces with underscores
  mutate(Prot_Col_Name = sub(" ", "_", Prot_Col_Name)) %>%
  ## Remove underscores if they are the last character in the string
  mutate(Prot_Col_Name = sub("_$", "", Prot_Col_Name)) %>%
  ## Replace forward slash with period
  mutate(Prot_Col_Name = sub("/", ".", Prot_Col_Name)) 

# Manually add suffix to TGFB1 because there are duplicates in the Prot_Col_Name column
prot_key[222,6] <- "TGF-beta_1_LAP"
prot_key[223,6] <- "TGF-beta_1_total"

# Rename columns

## Existing names for the first few sample info columns  
col_names_sampleinfo <- prot_data_raw[4, 1:17] %>%
  t() %>% as.data.frame() %>% pull("4")

## Cleaned protein names from the protein key
col_names_prots <- prot_key$Prot_Col_Name

## Combine
col_names_new <- c(col_names_sampleinfo, col_names_prots)

## Rename columns
prot_data <- prot_data_raw %>%
  slice(-c(1:4))

colnames(prot_data) <- col_names_new

# Select only columns of interest
prot_data <- prot_data %>% 
  
  # Select only columns of interest
  select(c(subgroup:donor_or_rep, rager_sample_id, Activin_A:XCL1))
```

What proteins were in the MaxPlex list but not measured?
```{r}
maxplex_prots <- full_list$Target

experiment_prots <- prot_key$Protein_Name

setdiff(maxplex_prots, experiment_prots)
```


# Characterize protein detection

First, we want to quantify, for each protein, how many measurements were either above or below the limit of detection. 

```{r}
prots_llod_summary <- prot_data %>% 
  group_by(subgroup) %>%
  summarise(across(Activin_A:XCL1, ~ sum(. == "<LLOD"))) %>%
  column_to_rownames("subgroup") %>%
  t() %>% data.frame() %>% 
  rename("Pre_LLOD" = "Pre", "Post_LLOD" = "Post") %>%
  rownames_to_column("Protein")

prots_ulod_summary <- prot_data %>% 
  group_by(subgroup) %>%
  summarise(across(Activin_A:XCL1, ~ sum(. == ">ULOD"))) %>%
  column_to_rownames("subgroup") %>%
  t() %>% data.frame() %>% 
  rename("Pre_ULOD" = "Pre", "Post_ULOD" = "Post") %>%
  rownames_to_column("Protein")

prot_detect_summary <- left_join(prots_llod_summary, prots_ulod_summary, by = "Protein")

nrow(prot_detect_summary %>% filter(Pre_ULOD > 0 & Pre_LLOD > 0))
nrow(prot_detect_summary %>% filter(Post_ULOD > 0 & Post_LLOD > 0))
```

There aren't any proteins that had both LLOD and ULOD values, so for now, we will proceed with treating them all as NAs, knowing that we can go back to this summary and determine which proteins these were above vs. below LOD. Now, we can convert the LLOD and ULOD strings to NAs:

```{r}
# Convert protein data to numeric data
prot_data <- prot_data %>%

  # Replace LLOD and ULOD with NA
  mutate(across(Activin_A:XCL1, \(x) sub("<LLOD", NA, x))) %>%
  mutate(across(Activin_A:XCL1, \(x) sub(">ULOD", NA, x))) %>%
  mutate(across(Activin_A:XCL1, \(x) as.numeric(x)))
```

How many proteins are completely undetected?
```{r}
# Count how many proteins were undetected
prot_data_allNA <- prot_data %>%
  summarise(across(Activin_A:XCL1, ~ all(is.na(.)))) %>%
  select_if(~ .)

ncol(prot_data_allNA)

# Get names of proteins not detected and store as dataframe for later summary
prots_allNA <- data.frame(Protein = colnames(prot_data_allNA), Det_AnySamples = "No")

# Filter to remove proteins with all NAs
prot_data_filt <- prot_data %>%
  select(!all_of(prots_allNA$Protein))

# Write out
write.xlsx(prot_data_filt %>% select(-c(subgroup:donor_or_rep)) %>% rename("sample_id" = "rager_sample_id"), "3_ProcessedData/ProcessedData_MaxPlex_RawData_Formatted_Filtered.xlsx")
```


Next, for examining missingness, we can quantify whether proteins were missing only in the Pre vs. Post samples, since they were collected for different periods of time (would expect potentially more missingness in media samples incubated for less time). 


```{r}
# PRE
# Tabulate missingness (NAs) in Pre data
prots_missing_pre <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  summarise(across(ADAM10:VISTA, ~ sum(is.na(.)))) %>%
  t() %>% data.frame() %>% 
  rename("NA_Count" = ".") %>%
  rownames_to_column("Protein")

# How many proteins were completely missing in the Pre data?
nrow(prots_missing_pre %>% filter(NA_Count == 48))

# How many proteins had no NAs in the Pre data?
nrow(prots_missing_pre %>% filter(NA_Count == 0))

# POST
# Tabulate missingness (NAs) in Post data
prots_missing_post <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  summarise(across(ADAM10:VISTA, ~ sum(is.na(.)))) %>%
  t() %>% data.frame() %>% 
  rename("NA_Count" = ".") %>%
  rownames_to_column("Protein")

# How many proteins were completely missing in the Post data?
nrow(prots_missing_post %>% filter(NA_Count == 48))

# How many proteins had no NAs in the Pre data?
nrow(prots_missing_post %>% filter(NA_Count == 0))
```

We can next use histograms to assess protein detection across timepoints and treatments:
```{r}
# PRE
# Prepare data frame
prot_data_forhist_byexpo_andday <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  select(-c(subgroup, donor_or_rep, rager_sample_id)) %>%
  group_by(treatment, timepoint) %>%
  summarise(across(everything(), ~ sum(!is.na(.x)))) %>%
  mutate(timepoint = factor(timepoint, levels = c("Day1", "Day3", "Day5", "Day8", "Day10", "Day12"))) %>%
  mutate(treatment = factor(treatment, levels = c("Ctrl", "RO"))) %>%
  pivot_longer(-c(timepoint, treatment), names_to = "variable", values_to = "value")
  
# Make plot
det_hist_byexpo_andday <- ggplot(prot_data_forhist_byexpo_andday, aes(x = value)) +
  geom_histogram(color = "black",
                   fill = "gray60",
                   alpha = 0.7,
                   binwidth = 1) +
  stat_count(geom = 'text', 
             color = 'black', 
             aes(label = after_stat(count)),
             position = position_nudge(y = 5)) +
  scale_x_continuous(breaks = seq(0, 4, by = 1), expand = c(0.025, 0.025)) +
  scale_y_continuous(breaks = seq(0, 120, by = 20), limits = c(0, 100), expand = c(0, 0)) +
  ylab("Number of Proteins") +
  xlab("Number of Detections") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = ggplot2::margin(t = 10)),
        axis.title.y = element_text(margin = ggplot2::margin(r = 10))) +
  facet_grid(rows = vars(treatment), cols = vars(timepoint))

det_hist_byexpo_andday

# Optionally save figure
#png("3_OutputFigs/1_DataCleaningMaxPlex/Hist_ProtDet_Pre_MaxPlex.png", width = 10, height = 5, res = 1200, units = "in")
#det_hist_byexpo_andday
#invisible(dev.off())
```

```{r}
# POST
# Prepare data frame
prot_data_forhist_byexpo_andday <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  select(-c(subgroup, donor_or_rep, rager_sample_id)) %>%
  group_by(treatment, timepoint) %>%
  summarise(across(everything(), ~ sum(!is.na(.x)))) %>%
  mutate(timepoint = factor(timepoint, levels = c("Day1", "Day3", "Day5", "Day8", "Day10", "Day12"))) %>%
  mutate(treatment = factor(treatment, levels = c("Ctrl", "RO"))) %>%
  pivot_longer(-c(timepoint, treatment), names_to = "variable", values_to = "value")
  
# Make plot
det_hist_byexpo_andday <- ggplot(prot_data_forhist_byexpo_andday, aes(x = value)) +
  geom_histogram(color = "black",
                   fill = "gray60",
                   alpha = 0.7,
                   binwidth = 1) +
  stat_count(geom = 'text', 
             color = 'black', 
             aes(label = after_stat(count)),
             position = position_nudge(y = 10)) +
  scale_x_continuous(breaks = seq(0, 4, by = 1), expand = c(0.025, 0.025)) +
  scale_y_continuous(breaks = seq(0, 150, by = 50), limits = c(0, 150), expand = c(0, 0)) +
  ylab("Number of Proteins") +
  xlab("Number of Detections") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(margin = ggplot2::margin(t = 10)),
        axis.title.y = element_text(margin = ggplot2::margin(r = 10))) +
  facet_grid(rows = vars(treatment), cols = vars(timepoint))

det_hist_byexpo_andday

# Optionally save figure
#png("3_OutputFigs/1_DataCleaningMaxPlex/Hist_ProtDet_Post_MaxPlex.png", width = 10, height = 5, res = 1200, units = "in")
#det_hist_byexpo_andday
#invisible(dev.off())
```

Next, we can explore filtering, starting with filtering for proteins that were expressed in 2 out of 4 donors in at least one exposure group (Ctrl or RO) on at least one of the days. 

Pre:
```{r}
# Select only Pre samples
prot_data_filt_pre <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  group_by(treatment, timepoint) %>%
  summarise(across(ADAM10:VISTA, ~ sum(!is.na(.x))))

# First, find proteins in the control group that fit the criteria
prot_data_filt_pre_ctrl <- prot_data_filt_pre %>%
  filter(treatment == "Ctrl") %>%
  column_to_rownames("timepoint") %>%
  t() %>% data.frame() %>%
  slice(-1) %>%
  
  # Sum number of days with detection in at least 2 donors
  mutate(across(c(Day1:Day8), \(x) as.numeric(x))) %>%
  mutate(count_2donors = rowSums(select(., starts_with("Day")) > 1)) %>%
  
  # Filter to detections in at least 1 day
  filter(count_2donors > 0) %>%
  
  # Get protein names
  rownames_to_column("Protein")

# Pull protein names
prots_pre_ctrl <- prot_data_filt_pre_ctrl$Protein

# Second, find proteins in the RO group that fit the criteria
prot_data_filt_pre_RO <- prot_data_filt_pre %>%
  filter(treatment == "RO") %>%
  column_to_rownames("timepoint") %>%
  t() %>% data.frame() %>%
  slice(-1) %>%
  
  # Sum number of days with detection in at least 2 donors
  mutate(across(c(Day1:Day8), \(x) as.numeric(x))) %>%
  mutate(count_2donors = rowSums(select(., starts_with("Day")) > 1)) %>%
  
  # Filter to detections in at least 1 day
  filter(count_2donors > 0) %>%
  
  # Get protein names
  rownames_to_column("Protein")

# Pull proteins names
prots_pre_ro <- prot_data_filt_pre_RO$Protein

# Final list
prots_pre_keep <- unique(c(prots_pre_ctrl, prots_pre_ro))
```

Post:
```{r}
# Select only Post samples
prot_data_filt_post <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  group_by(treatment, timepoint) %>%
  summarise(across(ADAM10:VISTA, ~ sum(!is.na(.x))))

# First, find proteins in the control group that fit the criteria
prot_data_filt_post_ctrl <- prot_data_filt_post %>%
  filter(treatment == "Ctrl") %>%
  column_to_rownames("timepoint") %>%
  t() %>% data.frame() %>%
  slice(-1) %>%
  
  # Sum number of days with detection in at least 2 donors
  mutate(across(c(Day1:Day8), \(x) as.numeric(x))) %>%
  mutate(count_2donors = rowSums(select(., starts_with("Day")) > 1)) %>%
  
  # Filter to detections in at least 1 day
  filter(count_2donors > 0) %>%
  
  # Get protein names
  rownames_to_column("Protein")

# Pull protein names
prots_post_ctrl <- prot_data_filt_post_ctrl$Protein

# Second, find proteins in the RO group that fit the criteria
prot_data_filt_post_ro <- prot_data_filt_post %>%
  filter(treatment == "RO") %>%
  column_to_rownames("timepoint") %>%
  t() %>% data.frame() %>%
  slice(-1) %>%
  
  # Sum number of days with detection in at least 2 donors
  mutate(across(c(Day1:Day8), \(x) as.numeric(x))) %>%
  mutate(count_2donors = rowSums(select(., starts_with("Day")) > 1)) %>%
  
  # Filter to detections in at least 1 day
  filter(count_2donors > 0) %>%
  
  # Get protein names
  rownames_to_column("Protein")

# Pull protein names
prots_post_ro <- prot_data_filt_post_ro$Protein

# Final list
prots_post_keep <- unique(c(prots_post_ctrl, prots_post_ro))
```

How do the pre- and post- keep list overlap?
```{r}
# How many unique to Pre?
length(setdiff(prots_pre_keep, prots_post_keep))

# How many unique to Post? 
length(setdiff(prots_post_keep, prots_pre_keep))

# How many shared?
length(intersect(prots_pre_keep, prots_post_keep))

# Make vector of proteins to keep
prots_keep <- unique(c(prots_pre_keep, prots_post_keep))
```

Prepare summary dataframe for detection of each proteins by different parameters:
```{r}
# Create dataframe and join initial detection dataframe
prot_det_summary <- data.frame(Protein = colnames(prot_data %>% select(Activin_A:XCL1))) %>%
  left_join(prots_allNA, by = "Protein") %>%
  mutate(Det_AnySamples = replace_na(Det_AnySamples, "Yes"))

# Create vectors for other detection paradigms
prots_alldet_pre  <- prots_missing_pre %>%
  mutate(Det_AllSamples_Pre = ifelse(NA_Count == 0, "Yes", "No")) %>%
  select(Protein, Det_AllSamples_Pre)

prots_alldet_post <- prots_missing_post %>%
  mutate(Det_AllSamples_Post = ifelse(NA_Count == 0, "Yes", "No")) %>%
  select(Protein, Det_AllSamples_Post)

prots_filtdet_pre <- data.frame(Protein = prots_pre_keep, Det_Filtered_Pre = "Yes")

prots_filtdet_post <- data.frame(Protein = prots_post_keep, Det_Filtered_Post = "Yes")

# Join those dataframes together
prot_det_summary <- prot_det_summary %>%
  left_join(prots_filtdet_pre, by = "Protein") %>%
  left_join(prots_alldet_pre, by = "Protein") %>%
  left_join(prots_filtdet_post, by = "Protein") %>%
  left_join(prots_alldet_post, by = "Protein") %>%
  mutate(across(everything(), \(x) replace_na(x, "No")))
```

Join protein detection summary to protein key and write out:
```{r}
# Query ensembl
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

prot_info <- getBM(
  attributes = c("uniprotswissprot", "description"),
  filters = "uniprotswissprot",
  values = prot_key$Uniprot_ID,
  mart = ensembl
) %>% 
  mutate(description_clean = str_remove(description, "\\[.*")) %>%
  select(c(uniprotswissprot, description_clean)) %>%
  rename("Uniprot_ID" = "uniprotswissprot", "Description" = "description_clean")

# Prepare dataframe
prot_key_final <- prot_key %>%
  left_join(prot_det_summary %>% 
              select(c(Protein, Det_Filtered_Post, Det_Filtered_Pre)), 
            join_by("Prot_Col_Name" == "Protein")) %>%
  left_join(prot_info, by = "Uniprot_ID") %>%
  rename("Protein_Column_Name" = "Prot_Col_Name", 
         "Passed_Detection_Filter_Pre" = "Det_Filtered_Pre", 
         "Passed_Detection_Filter_Post" = "Det_Filtered_Post") %>%
  relocate(c(Protein_Column_Name, Description), .after = "Protein_Name") %>%
  mutate(across(c(Upper_LOD, Lower_LOD), \(x) round(as.numeric(x), digits = 3)))

# Save data
write.xlsx(prot_key_final, "3_ProcessedData/ProcessedData_MaxPlex_ProteinKey.xlsx")
```

# Impute data

## Below LOD 

Read in GSimp functions:
```{r message = FALSE, warning = FALSE}
# Load GSimp functions
options(stringsAsFactors = F)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/4_GSimpFunctions_BelowLOD/Trunc_KNN/Imput_funcs.r', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/4_GSimpFunctions_BelowLOD/GSimp_evaluation.R', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/4_GSimpFunctions_BelowLOD/GSimp.R', local = TRUE)
```

Prepare vector of LLODs:
```{r}
prot_llods <- prot_key %>%
  clean_names() %>%
  mutate(mdl = as.numeric(lower_lod) * 2) %>%
  select(c(prot_col_name, mdl))
```

Prepare dataframes by first filtering to only proteins with values below the LLOD :
```{r}
## PRE
# Get proteins above ULOD
prots_aboveULOD_pre <- prot_detect_summary %>% 
  filter(Pre_ULOD > 0) %>%
  filter(Protein %in% prots_pre_keep) %>%
  pull("Protein")

# Prepare dataframe
prot_data_forimp_pre <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(prots_pre_keep)) %>%
  select(-all_of(prots_aboveULOD_pre)) %>%
  t() %>% data.frame() %>%
  rownames_to_column("prot_col_name") %>%
  left_join(prot_llods, by = "prot_col_name") %>%
  column_to_rownames("prot_col_name") %>%
  t() %>% data.frame()

## POST
# Get proteins above ULOD
prots_aboveULOD_post <- prot_detect_summary %>% 
  filter(Post_ULOD > 0) %>%
  filter(Protein %in% prots_post_keep) %>%
  pull("Protein")

# Prepare dataframe
prot_data_forimp_post <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(prots_post_keep)) %>%
  select(-all_of(prots_aboveULOD_post)) %>%
  t() %>% data.frame() %>%
  rownames_to_column("prot_col_name") %>%
  left_join(prot_llods, by = "prot_col_name") %>%
  column_to_rownames("prot_col_name") %>%
  t() %>% data.frame()
```

Apply function:
```{r}
set.seed(8016)

prot_data_imp_pre <- pre_processing_GS_wrapper(prot_data_forimp_pre)
prot_data_imp_post <- pre_processing_GS_wrapper(prot_data_forimp_post)
```

Visualize imputation results:
```{r}
## PRE
# Make data frame with original data that indicates whether a value was missing or not
imp_annotation_pre <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  select(c(rager_sample_id, all_of(prots_pre_keep))) %>%
  select(-all_of(prots_aboveULOD_pre)) %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  mutate(was_na = ifelse(is.na(value), "Yes", "No")) %>%
  dplyr::select(unique_id, was_na)

# Create dataframe to help with manual selection of which proteins to graph (want a subset of proteins with high, medium, and low missingness)
prots_missing_pre_filt <- prots_missing_pre %>%
  filter(Protein %in% colnames(prot_data_imp_pre))

# Manually select proteins to graph
prots_impgraph_pre <- c("CXCL11", "TNF_alpha", "TSLP", "CCL4", "ADAM9", "BMP3", "CCL3", "CXCL4", "DR4")

# Add annotation column and mdl to imputed data frame
imp_pre_withanno <- prot_data_imp_pre %>%
  rownames_to_column("rager_sample_id") %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  left_join(imp_annotation_pre, by = "unique_id") %>%
  left_join(prot_llods, join_by("protein" == "prot_col_name")) %>%
  filter(protein %in% prots_impgraph_pre) %>%
  mutate(protein = factor(protein, levels = prots_impgraph_pre)) %>%
  mutate(placeholder = "1")

# Make figure panel showing imputed versus non-imputed values
set.seed(8016)

imputation_panel_pre <- ggplot(data = imp_pre_withanno, aes(x = placeholder, y = value)) +
  geom_hline(aes(yintercept = mdl), linetype = 2, color = "grey32") +
  geom_point(aes(color = was_na), 
             size = 1, 
             alpha = 0.7, 
             position=position_jitter(width=0.1, height=0.1)) +
  scale_color_manual(values = c("black", "firebrick"), name = "Was imputed?", labels = c("No", "Yes")) +
  labs(y = "Concentration (pg/mL)") +
  scale_y_log10(expand = c(0, 0.5)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~protein, scales = "free_y", nrow = 3) 

# Optionally save figure
#pdf(file = "3_OutputFigs/1_DataCleaningMaxPlex/GSimp_Panel_Pre_LLOD_MaxPlex.pdf",
    #width = 7,
    #height = 5)
#imputation_panel_pre
#invisible(dev.off())
  
imputation_panel_pre
```

```{r}
## POST
# Make data frame with original data that indicates whether a value was missing or not
imp_annotation_post <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  select(c(rager_sample_id, all_of(prots_post_keep))) %>%
  select(-all_of(prots_aboveULOD_post)) %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  mutate(was_na = ifelse(is.na(value), "Yes", "No")) %>%
  dplyr::select(unique_id, was_na)

# Create dataframe to help with manual selection of which proteins to graph (want a subset of proteins with high, medium, and low missingness)
prots_missing_post_filt <- prots_missing_post %>%
  filter(Protein %in% colnames(prot_data_imp_post))

# Manually select proteins to graph
prots_impgraph_post <- c("CD209_antigen", "CCL27", "CD86", "CCL5", "TIMP2", "BMP3", "CCL28", "CHI3L1", "DR4")

# Add annotation column and mdl to imputed data frame
imp_post_withanno <- prot_data_imp_post %>%
  rownames_to_column("rager_sample_id") %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  left_join(imp_annotation_post, by = "unique_id") %>%
  left_join(prot_llods, join_by("protein" == "prot_col_name")) %>%
  filter(protein %in% prots_impgraph_post) %>%
  mutate(protein = factor(protein, levels = prots_impgraph_post)) %>%
  mutate(placeholder = "1")

# Make figure panel showing imputed versus non-imputed values
set.seed(8016)

imputation_panel_post <- ggplot(data = imp_post_withanno, aes(x = placeholder, y = value)) +
  geom_hline(aes(yintercept = mdl), linetype = 2, color = "grey32") +
  geom_point(aes(color = was_na), 
             size = 1, 
             alpha = 0.7, 
             position=position_jitter(width=0.1, height=0.1)) +
  scale_color_manual(values = c("black", "firebrick"), name = "Was imputed?", labels = c("No", "Yes")) +
  labs(y = "Concentration (pg/mL)") +
  scale_y_log10(expand = c(0, 0.5)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~protein, scales = "free_y", nrow = 3) 

# Optionally save figure panel
#pdf(file = "3_OutputFigs/1_DataCleaningMaxPlex/GSimp_Panel_Post_LLOD_MaxPlex.pdf",
   # width = 7,
    #height = 5)
#imputation_panel_post
#invisible(dev.off())
  
imputation_panel_post
```

## Above LOD

Read in GSimp functions:
```{r message = FALSE, warning = FALSE}
# Load GSimp functions
options(stringsAsFactors = F)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/5_GSimpFunctions_AboveLOD/Trunc_KNN/Imput_funcs.r', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/5_GSimpFunctions_AboveLOD/GSimp_evaluation.R', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/10_HBEC_RO_AcuteVsChronic_BulkSeq/1_CurrentAnalysis/3_SecretedProteins/5_GSimpFunctions_AboveLOD/GSimp.R', local = TRUE)
```

Prepare vector of ULODs:
```{r}
prot_ulods <- prot_key %>%
  clean_names() %>%
  mutate(mdl = as.numeric(upper_lod) * 2) %>%
  select(c(prot_col_name, mdl)) %>%
  mutate(prot_col_name = gsub("-", ".", prot_col_name)) %>%
  mutate(prot_col_name = gsub(" ", ".", prot_col_name))
```

Prepare dataframes by joining complete data columns to the proteins that were above the ULOD. This also involves removal of some of the complete data that had very low variance. For whatever reason, the above LOD code seems to be more sensitive to this than the below LOD code. The prob = part of the filtering can be experimented with to try to retain as much data as possible while not running into the "nulldev" error. 
```{r}
## PRE
# Get proteins below LLOD
prots_belowLLOD_pre <- prot_detect_summary %>% 
  filter(Pre_LLOD > 0) %>%
  filter(Protein %in% prots_pre_keep) %>%
  pull("Protein")

# Get proteins above ULOD
prots_aboveULOD_pre <- prot_detect_summary %>% 
  filter(Pre_ULOD > 0) %>%
  filter(Protein %in% prots_pre_keep) %>%
  pull("Protein")

# Prot data complete
prot_data_complete <- prot_data_filt %>% 
  filter(subgroup == "Pre") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(prots_pre_keep)) %>%
  select(-all_of(c(prots_belowLLOD_pre, prots_aboveULOD_pre)))

sds <- apply(prot_data_complete, 2, sd)
prot_data_complete_filt <- prot_data_complete[, which(sds > quantile(sds, prob = .05, na.rm = TRUE))] 

# Remove columns with little to no variance and add back in proteins to impute
prot_data_forimp_pre_aboveULOD <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(c(prots_aboveULOD_pre, colnames(prot_data_complete_filt)))) %>%
  t() %>% data.frame() %>%
  rownames_to_column("prot_col_name") %>%
  mutate(prot_col_name = gsub("-", ".", prot_col_name)) %>%
  mutate(prot_col_name = gsub(" ", ".", prot_col_name)) %>%
  left_join(prot_ulods, by = "prot_col_name") %>%
  column_to_rownames("prot_col_name") %>%
  t() %>% data.frame()

## POST
# Get proteins below LLOD
prots_belowLLOD_post <- prot_detect_summary %>% 
  filter(Post_LLOD > 0) %>%
  filter(Protein %in% prots_post_keep) %>%
  pull("Protein")

# Get proteins above ULOD
prots_aboveULOD_post <- prot_detect_summary %>% 
  filter(Post_ULOD > 0) %>%
  filter(Protein %in% prots_post_keep) %>%
  pull("Protein")

# Prot data complete
prot_data_complete <- prot_data_filt %>% 
  filter(subgroup == "Post") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(prots_post_keep)) %>%
  select(-all_of(c(prots_belowLLOD_post, prots_aboveULOD_post)))

sds <- apply(prot_data_complete, 2, sd)
prot_data_complete_filt <- prot_data_complete[, which(sds > quantile(sds, prob = .05, na.rm = TRUE))] 

# Remove columns with little to no variance and add back in proteins to impute
prot_data_forimp_post_aboveULOD <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  column_to_rownames("rager_sample_id") %>%
  select(all_of(c(prots_aboveULOD_post, colnames(prot_data_complete_filt)))) %>%
  t() %>% data.frame() %>%
  rownames_to_column("prot_col_name") %>%
  mutate(prot_col_name = gsub("-", ".", prot_col_name)) %>%
  mutate(prot_col_name = gsub(" ", ".", prot_col_name)) %>%
  left_join(prot_ulods, by = "prot_col_name") %>%
  column_to_rownames("prot_col_name") %>%
  t() %>% data.frame()
```

Apply function:
```{r}
set.seed(8016)

prot_data_imp_pre_aboveLOD <- pre_processing_GS_wrapper(prot_data_forimp_pre_aboveULOD)
prot_data_imp_post_aboveLOD <- pre_processing_GS_wrapper(prot_data_forimp_post_aboveULOD)
```

Visualize imputation results:
```{r}
## PRE
# Make data frame with original data that indicates whether a value was missing or not
imp_annotation_pre <- prot_data_filt %>%
  filter(subgroup == "Pre") %>%
  select(c(rager_sample_id, all_of(prots_pre_keep))) %>%
  select(c(rager_sample_id, all_of(prots_aboveULOD_pre))) %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  mutate(was_na = ifelse(is.na(value), "Yes", "No")) %>%
  dplyr::select(unique_id, was_na)

# Create dataframe to help with manual selection of which proteins to graph (want a subset of proteins with high, medium, and low missingness)
prots_missing_pre_filt <- prots_missing_pre %>%
  filter(Protein %in% prots_aboveULOD_pre)

# Add annotation column and mdl to imputed data frame
imp_pre_withanno <- prot_data_imp_pre_aboveLOD %>%
  rownames_to_column("rager_sample_id") %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  left_join(imp_annotation_pre, by = "unique_id") %>%
  left_join(prot_ulods, join_by("protein" == "prot_col_name")) %>%
  filter(protein %in% prots_aboveULOD_pre) %>%
  mutate(protein = factor(protein, levels = prots_aboveULOD_pre)) %>%
  mutate(placeholder = "1")

# Make figure panel showing imputed versus non-imputed values
set.seed(8016)

imputation_panel_pre <- ggplot(data = imp_pre_withanno, aes(x = placeholder, y = value)) +
  geom_hline(aes(yintercept = mdl), linetype = 2, color = "grey32") +
  geom_point(aes(color = was_na), 
             size = 1, 
             alpha = 0.7, 
             position=position_jitter(width=0.1, height=0.1)) +
  scale_color_manual(values = c("black", "firebrick"), name = "Was imputed?", labels = c("No", "Yes")) +
  labs(y = "Concentration (pg/mL)") +
  scale_y_log10(expand = c(0, 0.5)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~protein, scales = "free_y", nrow = 3) 

# Optionally save figure
#pdf(file = "3_OutputFigs/1_DataCleaningMaxPlex/GSimp_Panel_Pre_ULOD_MaxPlex.pdf",
    #width = 5,
    #height = 3)
#imputation_panel_pre
#invisible(dev.off())
  
imputation_panel_pre
```

```{r}
## POST
# Make data frame with original data that indicates whether a value was missing or not
imp_annotation_post <- prot_data_filt %>%
  filter(subgroup == "Post") %>%
  select(c(rager_sample_id, all_of(prots_post_keep))) %>%
  select(c(rager_sample_id, all_of(prots_aboveULOD_post))) %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  mutate(was_na = ifelse(is.na(value), "Yes", "No")) %>%
  dplyr::select(unique_id, was_na)

# Create dataframe to help with manual selection of which proteins to graph (want a subset of proteins with high, medium, and low missingness)
prots_missing_post_filt <- prots_missing_post %>%
  filter(Protein %in% prots_aboveULOD_post)

# Add annotation column and mdl to imputed data frame
imp_post_withanno <- prot_data_imp_post_aboveLOD %>%
  rownames_to_column("rager_sample_id") %>%
  pivot_longer(!rager_sample_id, names_to = "protein", values_to = "value") %>%
  unite("unique_id",  c(rager_sample_id, protein), remove = FALSE, sep = " ") %>%
  left_join(imp_annotation_post, by = "unique_id") %>%
  left_join(prot_ulods, join_by("protein" == "prot_col_name")) %>%
  filter(protein %in% prots_aboveULOD_post) %>%
  mutate(protein = factor(protein, levels = prots_aboveULOD_post)) %>%
  mutate(placeholder = "1")

# Make figure panel showing imputed versus non-imputed values
set.seed(8016)

imputation_panel_post <- ggplot(data = imp_post_withanno, aes(x = placeholder, y = value)) +
  geom_hline(aes(yintercept = mdl), linetype = 2, color = "grey32") +
  geom_point(aes(color = was_na), 
             size = 1, 
             alpha = 0.7, 
             position=position_jitter(width=0.1, height=0.1)) +
  scale_color_manual(values = c("black", "firebrick"), name = "Was imputed?", labels = c("No", "Yes")) +
  labs(y = "Concentration (pg/mL)") +
  scale_y_log10(expand = c(0, 0.5)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~protein, scales = "free_y", nrow = 3) 

# Optionally save figure
#pdf(file = "3_OutputFigs/1_DataCleaningMaxPlex/GSimp_Panel_Post_ULOD_MaxPlex.pdf",
   # width = 3.5,
    #height = 2)
#imputation_panel_post
#invisible(dev.off())
  
imputation_panel_post
```


# Organize data for final export
```{r}
# Pre data
prot_data_pre_final_imp <- prot_data_imp_pre_aboveLOD %>%
  select(any_of(prots_aboveULOD_pre)) %>%
  rownames_to_column("rager_sample_id") %>%
  left_join(prot_data_imp_pre %>% rownames_to_column("rager_sample_id"), by = "rager_sample_id") %>%
  rename("sample_id" = "rager_sample_id")

# Post data
prot_data_post_final_imp <- prot_data_imp_post_aboveLOD %>%
  select(c("IL.8", any_of(prots_aboveULOD_post))) %>%
  rownames_to_column("rager_sample_id") %>%
  left_join(prot_data_imp_post %>% rownames_to_column("rager_sample_id"), by = "rager_sample_id") %>%
  rename("sample_id" = "rager_sample_id")

# Write out 
write.xlsx(prot_data_pre_final_imp, "3_ProcessedData/ProcessedData_MaxPlex_Imputed_Pre.xlsx")
write.xlsx(prot_data_post_final_imp, "3_ProcessedData/ProcessedData_MaxPlex_Imputed_Post.xlsx")
```


