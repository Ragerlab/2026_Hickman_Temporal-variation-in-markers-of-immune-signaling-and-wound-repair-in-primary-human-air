---
title: "Interindividual_analysis"
output:
  html_document: default
  pdf_document: default
date: "2025-10-21"
---

```{r}
library(tidyverse)
library(factoextra)
library(vegan)
library(lme4)
library(lmerTest)
library(Hmisc)
```

# Load in pre and post protein data
```{r, warning = F, message = F}
load('3_ProcessedData/pre_key.Rdata') 
load('3_ProcessedData/pre_log2.Rdata')
load('3_ProcessedData/post_key.Rdata')
load('3_ProcessedData/post_log2.Rdata')
```

# PRE - Recreate donor PCAs to make sure everything is consistent 
```{r}
# Run PCA
pca_pre <- prcomp(pre_log2 %>% column_to_rownames("sample_id"), center = TRUE, scale = TRUE)

# Visualize PCA - Donor
pca_plot_pre_donor <- fviz_pca_ind(pca_pre, 
             label = "none",
             pointsize = 3, 
             habillage = pre_key$donor, 
             mean.point = FALSE,
             addEllipses = TRUE) +
  labs(title = "PCA: By Donor (Pre)") +
  scale_color_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_fill_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_shape_manual(name = "Donor", values = c(15, 16, 17, 18)) + 
  theme(axis.title = element_text(size = rel(1.1)),
      panel.border = element_rect(fill = NA, color = "black", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(0, 0.5, 0, 0), "in"))

pca_plot_pre_donor
```

# POST - Recreate donor PCAs to make sure everything is consistent 
```{r}
# Run PCA
pca_post <- prcomp(post_log2 %>% column_to_rownames("sample_id"), center = TRUE, scale = TRUE)

# Visualize PCA - Donor
pca_plot_post_donor <- fviz_pca_ind(pca_post, 
             label = "none",
             pointsize = 3, 
             habillage = post_key$donor, 
             mean.point = FALSE,
             addEllipses = TRUE) +
  labs(title = "PCA: By Donor (Post)") +
  scale_color_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_fill_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_shape_manual(name = "Donor", values = c(15, 16, 17, 18)) + 
  theme(axis.title = element_text(size = rel(1.1)),
      panel.border = element_rect(fill = NA, color = "black", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(0, 0.5, 0, 0), "in"))

pca_plot_post_donor
```

# Subset to shared proteins and time points for fair comparison
```{r}
# Get unique proteins
prot_pre <- colnames(pre_log2)[-1]
prot_post <- colnames(post_log2)[-1]

# Intersection between two
common <- intersect(prot_pre, prot_post)
length(common)

# Subset to shared proteins and remove day 1 from post since it doesn't exist in pre
pre_sub <- pre_log2[, colnames(pre_log2) %in% c('sample_id', common)] 
post_sub <- post_log2[, colnames(post_log2) %in% c('sample_id', common)] %>% 
  filter(!str_detect(sample_id, pattern = 'Day1_'))
post_key <- post_key %>%
  filter(timepoint != 'Day1')
```

# Updated pre PCA
```{r}
# Run PCA
pca_pre <- prcomp(pre_sub %>% column_to_rownames("sample_id"), center = TRUE, scale = TRUE)

# Visualize PCA - Donor
pca_plot_pre_donor <- fviz_pca_ind(pca_pre, 
             label = "none",
             pointsize = 3, 
             habillage = pre_key$donor, 
             mean.point = FALSE,
             addEllipses = TRUE) +
  labs(title = "PCA: By Donor (Pre)") +
  scale_color_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_fill_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_shape_manual(name = "Donor", values = c(15, 16, 17, 18)) + 
  theme(axis.title = element_text(size = rel(1.1)),
      panel.border = element_rect(fill = NA, color = "black", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(0, 0.5, 0, 0), "in"))

pca_plot_pre_donor
```

# Updated PCA post
```{r}
# Run PCA
pca_post <- prcomp(post_sub %>% column_to_rownames("sample_id"), center = TRUE, scale = TRUE)

# Visualize PCA - Donor
pca_plot_post_donor <- fviz_pca_ind(pca_post, 
             label = "none",
             pointsize = 3, 
             habillage = post_key$donor, 
             mean.point = FALSE,
             addEllipses = TRUE) +
  labs(title = "PCA: By Donor (Post)") +
  scale_color_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_fill_manual(name = "Donor", values = c("#7ad151", "#22a884", "#2a788e", "#414487")) +
  scale_shape_manual(name = "Donor", values = c(15, 16, 17, 18)) + 
  theme(axis.title = element_text(size = rel(1.1)),
      panel.border = element_rect(fill = NA, color = "black", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(0, 0.5, 0, 0), "in"))

pca_plot_post_donor
```


# Compare mean distances between donors
```{r}
dist_pre  <- as.vector(vegdist(pre_sub[,-1], method = "euclidean"))
dist_post <- as.vector(vegdist(post_sub[,-1], method = "euclidean"))

mean_pre  <- mean(dist_pre)
mean_post <- mean(dist_post)

# Compare distributions
dist_test <- t.test(dist_pre, dist_post, paired = FALSE)
dist_test

df_dist <- rbind(
  data.frame(Distance = dist_pre, Condition = "Pre"),
  data.frame(Distance = dist_post, Condition = "Post")
)

p <- ggplot(df_dist, aes(x = Condition, y = Distance, fill = Condition)) +
  geom_boxplot(alpha = 0.7) +
  theme_classic() +
  ylab("Pairwise Euclidean Distance") +
  ggtitle("Between-sample protein distances (Pre vs Post)")
p

```

# Multivariate dispersion test
```{r}
# Combine data
combined <- rbind(pre_sub, post_sub)
condition <- factor(c(rep("Pre", nrow(pre_sub)), rep("Post", nrow(post_sub))))

# Compute Euclidean distances
dist_mat <- vegdist(combined[,-1], method = "euclidean")

# Test for differences in multivariate dispersion 
dispersion <- betadisper(dist_mat, group = condition)
anova_disp <- anova(dispersion)

# Permutation test (more robust)
perm_disp <- permutest(dispersion, pairwise = TRUE)

# Visualize
plot(dispersion, hull = FALSE, ellipse = TRUE, main = "Multivariate dispersion (Pre vs Post)")

anova_disp
perm_disp
```

# Mixed modeling using per-sample mean distance
```{r}
pre_meta <- pre_key %>% rownames_to_column(., "sample_id")
post_meta <- post_key %>% rownames_to_column(., "sample_id")

# Join metadata
pre_df  <- pre_sub  %>% left_join(pre_meta, by = "sample_id")
post_df <- post_sub %>% left_join(post_meta, by = "sample_id")


# Helper: compute distance-to-centroid per-sample for each condition/timepoint block
compute_mean_distances <- function(df){ 
  # df must contain sample_id, donor, timepoint, and only numeric protein columns otherwise
  tps <- unique(df$timepoint)
  out <- map_df(tps, function(tp){
    block <- df %>% filter(timepoint == tp)
    if(nrow(block) < 2) return(tibble())
    expr <- block %>% dplyr::select(-sample_id, -donor, -exposure, -timepoint) %>% as.matrix()
    dmat <- as.matrix(vegdist(expr, method = "euclidean"))
    mean_to_others <- rowMeans(dmat, na.rm = TRUE)
    tibble(sample_id = block$sample_id,
           donor = block$donor,
           timepoint = tp,
           mean_dist = mean_to_others)
  })
  out
}

mean_pre_df  <- compute_mean_distances(pre_df)
mean_post_df <- compute_mean_distances(post_df)

mean_dist_df <- bind_rows(mean_pre_df %>% mutate(condition = "Pre"),
                          mean_post_df %>% mutate(condition = "Post")) 

# Mixed model: mean_dist ~ condition + timepoint (as factor) + (1|donor)
mean_dist_df$timepoint <- as.numeric(str_replace(mean_dist_df$timepoint, pattern = 'Day', ''))
mean_dist_df$condition <- factor(mean_dist_df$condition, levels = c("Pre", "Post"))

model1 <- lmer(mean_dist ~ condition + timepoint + (1 | donor), data = mean_dist_df)
summary(model1)

# plot
p <- ggplot(mean_dist_df, aes(x = timepoint, y = mean_dist, color = condition)) + 
  geom_point(aes(shape = donor), alpha = 0.6) +
  stat_summary(fun.data = mean_cl_boot, geom = "line", linewidth = 1.2) +
  stat_summary(fun.data = mean_cl_boot, geom = "ribbon", alpha = 0.15, aes(fill = condition), color = NA) +
  labs(x = "Timepoint", y = "Mean distance") +
  theme_minimal()

```

